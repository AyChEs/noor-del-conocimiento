rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ──────────────────────────────────────────────────────────
    // Perfiles de usuario
    // Solo el propio usuario puede leer y escribir su perfil.
    // ──────────────────────────────────────────────────────────
    match /users/{uid} {
      allow read, write: if request.auth != null && request.auth.uid == uid;

      // Historial de preguntas (SRS) — mismo propietario
      match /questionHistory/{questionId} {
        allow read, write: if request.auth != null && request.auth.uid == uid;
      }
    }

    // ──────────────────────────────────────────────────────────
    // Tabla de clasificación
    // - Cualquiera puede leer (incluso sin sesión)
    // - Solo el propio usuario puede escribir su propia entrada
    // - El score solo puede subir (protección anti-trampa básica)
    // ──────────────────────────────────────────────────────────
    match /leaderboard/{uid} {
      allow read: if true;
      allow create: if request.auth != null
                    && request.auth.uid == uid
                    && request.resource.data.bestScore is int
                    && request.resource.data.bestScore >= 0
                    && request.resource.data.bestScore <= 100;
      allow update: if request.auth != null
                    && request.auth.uid == uid
                    && request.resource.data.bestScore >= resource.data.bestScore;
    }
  }
}
